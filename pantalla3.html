<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Carrito – Salida Zapata V2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(to right, #00416A, #E4E5E6);
    margin: 0;
    padding: 20px;
    color: white;
    min-height: 100vh;
  }

  .contenedor {
    max-width: 600px;
    margin: auto;
    background: rgba(255,255,255,0.12);
    padding: 25px;
    border-radius: 12px;
    backdrop-filter: blur(12px);
  }

  h2 { text-align: center; margin-bottom: 25px; }

  .item {
    background: white;
    color: black;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .btn {
    background: #d32f2f;
    color: white;
    padding: 12px;
    width: 100%;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    margin-top: 15px;
  }

  .btn:hover { background: #b71c1c; cursor: pointer; }

  .eliminar {
    background: #b71c1c;
    color: white;
    border: none;
    padding: 8px 10px;
    border-radius: 6px;
    cursor: pointer;
  }

  .folio {
    font-size: 16px;
    text-align: center;
    background: rgba(255,255,255,0.2);
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
</style>

</head>
<body>

<div class="contenedor">

  <h2>Carrito de Salida</h2>

  <p class="folio">Folio: <strong id="folioMostrar">...</strong></p>

  <div id="listaCarrito"></div>

  <button class="btn" onclick="guardarSalida()">Registrar Salida</button>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
// --- CONFIG FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.firebasestorage.app",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ======================================================
// ✔ Cargar y mostrar carrito
// ======================================================
let carrito = JSON.parse(localStorage.getItem("carrito")) || [];

function mostrarCarrito() {
  const lista = document.getElementById("listaCarrito");
  lista.innerHTML = "";

  if (carrito.length === 0) {
    lista.innerHTML = "<p>No hay productos en el carrito.</p>";
    return;
  }

  carrito.forEach((item, index) => {
    const div = document.createElement("div");
    div.className = "item";

    div.innerHTML = `
      <div>
        <strong>${item.nombre}</strong><br>
        <small>Código: ${item.codigo}</small><br>
        <small>Cantidad: ${item.cantidad}</small>
      </div>
      <button class="eliminar" onclick="eliminar(${index})">X</button>
    `;

    lista.appendChild(div);
  });
}

function eliminar(i) {
  carrito.splice(i, 1);
  localStorage.setItem("carrito", JSON.stringify(carrito));
  mostrarCarrito();
}

// ======================================================
// ✔ Guardar salida en Firestore
// ======================================================
async function guardarSalida() {
  if (carrito.length === 0)
    return alert("El carrito está vacío.");

  const entrega = localStorage.getItem("entrega");
  const recibe = localStorage.getItem("recibe");
  const destino = localStorage.getItem("destino");
  const fecha = localStorage.getItem("fecha");
  const folio = document.getElementById("folioMostrar").textContent;

  if (!entrega || !recibe || !destino)
    return alert("Faltan datos iniciales.");

  // ✔ Registrar cada movimiento en el almacén_zapataV2
  for (const p of carrito) {
    await db.collection("almacenes")
            .doc("almacen_zapataV2")
            .collection("entradas")
            .add({
              fecha: fecha,
              folio: folio,
              entrega,
              recibe,
              destino,
              codigo: p.codigo,
              descripcion: p.nombre,
              cantidad: p.cantidad,
              tipoMovimiento: "salida"
            });
  }

  // ✔ Actualizar consecutivo
  const docRef = db.collection("consecutivos").doc("salidas_zapata");
  const snap = await docRef.get();

  let nuevo = 1;
  if (snap.exists) nuevo = (snap.data().ultimo || 1) + 1;

  await docRef.set({ ultimo: nuevo }, { merge: true });

  // ✔ Limpiar carrito
  localStorage.removeItem("carrito");

  alert("Salida registrada correctamente.");
  window.location.href = "index.html";
}

// ======================================================
// ✔ Obtener folio
// ======================================================
async function cargarFolio() {
  const docRef = db.collection("consecutivos").doc("salidas_zapata");
  const doc = await docRef.get();
  let n = 1;

  if (doc.exists) n = doc.data().ultimo || 1;

  const folio = "PDDZAP - " + String(n).padStart(4, "0");
  document.getElementById("folioMostrar").textContent = folio;
}

// ======================================================
// INIT
// ======================================================
document.addEventListener("DOMContentLoaded", () => {
  cargarFolio();
  mostrarCarrito();
});

</script>

</body>
</html>
