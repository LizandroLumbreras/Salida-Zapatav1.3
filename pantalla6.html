<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resumen de Salida</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>

    body { 
      font-family: Arial, sans-serif; 
      background: linear-gradient(to right, #00416A, #E4E5E6); 
      color: white; 
      padding: 20px; 
    }

    .resumen { 
      background: white; 
      color: black; 
      border-radius: 10px; 
      padding: 20px; 
      max-width: 800px; 
      margin: auto; 
    }

    h2 { text-align: center; }

    ul { list-style: none; padding: 0; }
    li { 
      margin-bottom: 10px; 
      background: #f2f2f2; 
      padding: 10px; 
      border-radius: 6px; 
    }

    .firmas {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }

    .firmas div { width: 45%; text-align: center; }
    .firmas img {
      max-width: 100%;
      background: white;
      border-radius: 6px;
      border:1px solid #ccc;
      height: 120px;
    }

    button {
      display: block;
      margin: 25px auto 0;
      padding: 12px 20px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }

    .secondary {
      background: #007bff;
    }

    /* =======================================================
       üßæ IMPRESI√ìN T√âRMICA 58 mm ‚Äî Epson TM-T20III
       ======================================================= */
    @media print {

      body {
        background: white !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      .resumen {
        width: 280px !important; /* ancho ticket 58mm */
        padding: 10px !important;
        margin: 0 auto !important;
        font-size: 12px !important;
        line-height: 1.25 !important;
        border-radius: 0 !important;
      }

      h2 {
        font-size: 14px !important;
        margin-bottom: 8px !important;
      }

      ul li {
        background: none !important;
        padding: 4px 0 !important;
        border: none !important;
        font-size: 11px !important;
      }

      .firmas img {
        width: 95% !important;
        height: 60px !important;
        border: 1px solid #000 !important;
        filter: contrast(180%);
      }

      button, .no-print {
        display: none !important;
      }
    }
.firmas-vertical {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-top: 20px;
}

.firmas-vertical div {
  width: 100%;
  text-align: center;
  margin-bottom: 25px;
}

.firmas-vertical img {
  width: 90%;
  max-width: 260px;
  height: 110px;
  border: 1px solid #000;
  border-radius: 6px;
  background: white;
}

@media print {
  .firmas-vertical img {
    width: 95% !important;
    height: 60px !important;
    filter: contrast(180%);
  }
}

  </style>
</head>

<body>

<div class="resumen">
  <h2>üìã Resumen de salida</h2>

  <p><strong>Folio:</strong> <span id="folio">Cargando‚Ä¶</span></p>
  <p><strong>Fecha:</strong> <span id="fecha"></span></p>
  <p><strong>Entrega:</strong> <span id="entrega"></span></p>
  <p><strong>Recibe:</strong> <span id="recibe"></span></p>
  <p><strong>Destino:</strong> <span id="destino"></span></p>

  <h3>üõí Art√≠culos:</h3>
  <ul id="lista-articulos"></ul>

  <h3 id="folioCinchoMostrar" style="text-align:center;margin-top:10px;"></h3>

<div class="firmas-vertical">
  <div>
    <p>Firma quien entrega</p>
    <img id="firmaEntrega" src="">
  </div>

  <div>
    <p>Firma quien recibe</p>
    <img id="firmaRecibe" src="">
  </div>
</div>


 <button class="no-print" onclick="guardarEnFirebase()">üíæ Guardar salida</button>
  <button class="secondary no-print" onclick="imprimir()">üñ®Ô∏è Imprimir</button>
</div>


<!-- ==================== MODAL CINCHO ==================== -->

<div id="modalCincho" class="no-print" 
     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:9999;">

  <div style="background:white; color:black; padding:20px; border-radius:10px; width:90%; max-width:350px; text-align:center;">
    <h3>üöö Folio de Cincho</h3>

    <input id="folioCinchoInput" type="text" placeholder="Ej. CIN-10023" 
           style="width:80%; padding:8px; border:1px solid #ccc; border-radius:5px;"><br><br>

    <label>
      <input type="checkbox" id="noCamionCheck"> No es cami√≥n
    </label>

    <br><br>
    <button onclick="confirmarCincho()" 
            style="background:#007bff;color:white;padding:10px;margin-right:5px;">Continuar</button>
    <button onclick="cerrarModalCincho()" 
            style="background:#888;color:white;padding:10px;">Cancelar</button>
  </div>

</div>

<!-- ==================== Firebase ==================== -->

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>

const firebaseConfig = {
  apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
  authDomain: "inventariopv-643f1.firebaseapp.com",
  projectId: "inventariopv-643f1",
  storageBucket: "inventariopv-643f1.appspot.com",
  messagingSenderId: "96242533231",
  appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();


let numeroFolio = 0;
let folio = "";


// ======================================================
// OBTENER FOLIO AUTOM√ÅTICO
// ======================================================
async function obtenerFolio() {
  const ref = db.collection("consecutivos").doc("salidas_zapata");
  const snap = await ref.get();

  numeroFolio = (snap.exists ? snap.data().ultimo : 0) + 1;

  folio = "PDDZAP - " + String(numeroFolio).padStart(4, "0");
  document.getElementById("folio").textContent = folio;
}


// ======================================================
// Cargar los datos del resumen
// ======================================================
function cargarResumen() {

  document.getElementById("fecha").textContent =
    localStorage.getItem("resumenFecha") ||
    localStorage.getItem("fecha") ||
    "";

  document.getElementById("entrega").textContent =
    localStorage.getItem("entrega") || "";

  document.getElementById("recibe").textContent =
    localStorage.getItem("recibe") || "";

  document.getElementById("destino").textContent =
    localStorage.getItem("destino") || "";

  document.getElementById("firmaEntrega").src =
    localStorage.getItem("firmaEntrega") || "";

  document.getElementById("firmaRecibe").src =
    localStorage.getItem("firmaRecibe") || "";

  // art√≠culos
  const lista = JSON.parse(localStorage.getItem("carrito") || "[]");
  const ul = document.getElementById("lista-articulos");

  lista.forEach(p => {
    const li = document.createElement("li");
    li.textContent = `${p.cantidad} x ${p.nombre} (C√≥digo: ${p.codigo})`;
    ul.appendChild(li);
  });

  // mostrar cincho si existe
  const cincho = localStorage.getItem("folioCincho") || "";
  if (cincho !== "") {
    document.getElementById("folioCinchoMostrar").textContent =
      "üöö Folio de Cincho: " + cincho;
  }
}


// ======================================================
// Modal Cincho
// ======================================================
function guardarSalida() {
  document.getElementById("modalCincho").style.display = "flex";
}

function cerrarModalCincho() {
  document.getElementById("modalCincho").style.display = "none";
}

async function confirmarCincho() {
  const cincho = document.getElementById("folioCinchoInput").value.trim();
  const noCamion = document.getElementById("noCamionCheck").checked;

  if (!noCamion && cincho === "") {
    alert("Debes ingresar el folio de cincho o marcar que no es cami√≥n.");
    return;
  }

  // Guardar cincho en localStorage INMEDIATAMENTE
  localStorage.setItem("folioCincho", noCamion ? "" : cincho);

  document.getElementById("folioCinchoMostrar").textContent =
    noCamion ? "" : ("üöö Folio de Cincho: " + cincho);

  cerrarModalCincho();
}
// ======================================================
// GUARDAR EN FIRESTORE
// ======================================================
async function guardarEnFirebase(folioCincho, noCamion) {

  const salida = {
    folio,
    fecha: document.getElementById("fecha").textContent,
    entrega: localStorage.getItem("entrega"),
    recibe: localStorage.getItem("recibe"),
    destino: localStorage.getItem("destino"),
    articulos: JSON.parse(localStorage.getItem("carrito") || "[]"),
    firmaEntrega: localStorage.getItem("firmaEntrega"),
    firmaRecibe: localStorage.getItem("firmaRecibe"),
    folioCincho: noCamion ? "" : folioCincho,
    timestamp: new Date()
  };

  try {
    await db.collection("almacenes")
      .doc("almacen_zapataV2")
      .collection("salidas")
      .add(salida);

    await db.collection("consecutivos")
      .doc("salidas_zapata")
      .set({ ultimo: numeroFolio }, { merge: true });

    alert("Salida guardada correctamente.");

    localStorage.clear();
    window.location.href = "index.html";

  } catch (error) {
    console.error(error);
    alert("Error al guardar.");
  }
}


// ======================================================
// IMPRIMIR TICKET
// ======================================================
function imprimir() {
  window.print();
}


// ======================================================
document.addEventListener("DOMContentLoaded", async () => {

  await obtenerFolio();
  cargarResumen();

  // üî• Mostrar modal cincho autom√°ticamente
  setTimeout(() => {
    document.getElementById("modalCincho").style.display = "flex";
  }, 400);
});
</script>
</body>
</html>
